<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Count Body Pieces</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-size: 1.8em;
        }
        .container {
            width: 100%;
            padding: 20px 20px;
            margin: 0 auto;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        fieldset {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
        }
        legend {
            font-weight: bold;
            font-size: 2em;
            padding: 0 10px;
        }
        .form-group {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        label {
            font-weight: 600;
        }
        input[type="number"] {
            width: 100px;
            padding: 10px;
            font-size: 1.5em;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .button-container {
            text-align: center;
            margin-top: 30px;
        }
        button, .btn {
            font-size: 1.5em;
            padding: 10px 25px;
            border-radius: 8px;
        }
        .key-helper {
            margin-top: 50px;
            font-size: 1em;
            color: #222;
            display: none;
        }
        .key-helper.show {
            display: block;
        }
        .key-helper code {
            background: #eee;
            padding: 5px 10px;
            margin: 5px;
            display: inline-block;
            font-size: 1.2em;
        }
        .shortcut-row {
            margin: 8px 0;
        }
        .shortcut-label {
            font-weight: 700;
            margin-right: 10px;
        }

        input.highlight-add {
            animation: highlightAdd 3s ease;
            border: 3px solid limegreen;
            background-color: #c6f7c6;
        }

        input.highlight-remove {
            animation: highlightRemove 3s ease;
            border: 3px solid #d9534f;
            background-color: #f8d7da;
        }

        @keyframes highlightAdd {
            0%   { background-color: #c6f7c6; }
            100% { background-color: white; }
        }

        @keyframes highlightRemove {
            0%   { background-color: #f8d7da; }
            100% { background-color: white; }
        }
        .size-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 14px;
        }
        .size-6ft {
            background-color: #f7f7fb;
        }
        .size-7ft {
            background-color: #f3f8f3;
        }
        .size-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: left;
        }
        .action-status {
            margin-top: 10px;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1.1em;
            border: 1px solid transparent;
        }
        .action-status.hidden {
            display: none;
        }
        .action-status.add {
            background: #e8f5e9;
            color: #1b5e20;
            border-color: #c8e6c9;
        }
        .action-status.remove {
            background: #fbe9e7;
            color: #b71c1c;
            border-color: #ffccbc;
        }
        .remove-mode-indicator {
            display: none;
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            background: #fbe9e7;
            color: #b71c1c;
            font-weight: 700;
            font-size: 1em;
        }
        .remove-mode-indicator.show {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="action-status hidden" id="actionStatus"></div>
        <div class="remove-mode-indicator" id="removeModeIndicator">Remove mode: Home key held</div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form action="{{ url_for('body_pieces') }}" method="post">
            <div class="grid-container">
                {% set colors = ['Black', 'Rustic Oak', 'Grey Oak', 'Stone', 'Rustic Black'] %}
                {% set sizes = ['7ft', '6ft'] %}
                {% set piece_types = [
                    {'key': 'window_side', 'label': 'Window Side'},
                    {'key': 'blank_side', 'label': 'Blank Side'},
                    {'key': 'triangle_end', 'label': 'Colour End'},
                    {'key': 'color_ball_end', 'label': 'White Ball End'}
                ] %}

                {% set ns = namespace(first_six=true) %}
                {% for color in colors %}
                <fieldset>
                    <legend>{{ color }}</legend>
                    {% for size in sizes %}
                        <div class="size-section {% if size == '6ft' %}size-6ft{% else %}size-7ft{% endif %}"{% if size == '6ft' and ns.first_six %} id="sixFtAnchor"{% set ns.first_six = false %}{% endif %}>
                            <div class="size-title">{{ size }}</div>
                            {% for piece in piece_types %}
                                {% set part_name = piece.label %}
                                {% set part_key = color|lower|replace(' ', '_') ~ '_' ~ size|replace('ft','') ~ '_' ~ piece.key %}
                                {% set input_name = 'piece_' ~ part_key %}
                                <div class="form-group">
                                    <label for="{{ input_name }}">{{ part_name }}</label>
                                    <input type="number" id="{{ input_name }}" name="{{ input_name }}" value="{{ counts.get(input_name, 0) }}" min="0" required>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </fieldset>
                {% endfor %}
            </div>
            <div class="button-container">
                <button type="submit" class="btn btn-primary">Update Counts</button>
            </div>
        </form>
        <div class="button-container">
            <a href="{{ url_for('home') }}" class="btn">Back to Main Menu</a>
        </div>
        <div class="button-container">
            <button type="button" class="btn" id="toggleShortcuts">Show Quick Add Shortcuts</button>
        </div>

        <div class="key-helper" id="keyHelper">
            <h3 style="font-size: 2em;">Quick Add (Keyboard Shortcuts)</h3>
            <p>Press a key to add 1. Hold <strong>Shift</strong> or <strong>Home</strong> to remove 1.</p>
            {% for color_group in shortcut_groups %}
                <strong>{{ color_group.color }}:</strong><br>
                {% for size_group in color_group.sizes %}
                    <div class="shortcut-row">
                        <span class="shortcut-label">{{ size_group.size }}:</span>
                        {% for item in size_group.entries %}
                            <code>{{ item.key }}</code> {{ item.label }}
                        {% endfor %}
                    </div>
                {% endfor %}
                <br>
            {% endfor %}
        </div>
    </div>

    <script>
    const keyMap = {{ key_map|tojson }};
    const keyHelper = document.getElementById('keyHelper');
    const toggleButton = document.getElementById('toggleShortcuts');
    const removeModeIndicator = document.getElementById('removeModeIndicator');
    const actionStatus = document.getElementById('actionStatus');
    let homeRemoveActive = false;
    let shiftScrollDone = false;
    let shiftOriginalScroll = null;

    function setRemoveMode(active) {
        homeRemoveActive = active;
        if (removeModeIndicator) {
            removeModeIndicator.classList.toggle('show', active);
        }
    }

    function buildActionLabel(partKey) {
        const inputId = 'piece_' + partKey;
        const inputField = document.getElementById(inputId);
        if (!inputField) {
            return partKey;
        }
        const label = document.querySelector('label[for="' + inputId + '"]');
        const sizeSection = inputField.closest('.size-section');
        const fieldset = inputField.closest('fieldset');
        const color = fieldset ? fieldset.querySelector('legend')?.textContent.trim() : '';
        const size = sizeSection ? sizeSection.querySelector('.size-title')?.textContent.trim() : '';
        const piece = label ? label.textContent.trim() : '';
        return [color, size, piece].filter(Boolean).join(' ');
    }

    function updateActionStatus(partKey, action) {
        if (!actionStatus) {
            return;
        }
        const label = buildActionLabel(partKey);
        const verb = action === 'remove' ? 'Removed 1' : 'Added 1';
        actionStatus.textContent = label ? `${verb}: ${label}` : `${verb}.`;
        actionStatus.classList.remove('hidden', 'add', 'remove');
        actionStatus.classList.add(action === 'remove' ? 'remove' : 'add');
    }

    toggleButton.addEventListener('click', function() {
        const isVisible = keyHelper.classList.toggle('show');
        toggleButton.textContent = isVisible ? 'Hide Quick Add Shortcuts' : 'Show Quick Add Shortcuts';
    });

    function applyCountUpdate(partKey, newCount, action) {
        const inputId = 'piece_' + partKey;
        const inputField = document.getElementById(inputId);
        if (!inputField) {
            return;
        }
        inputField.value = newCount;
        const highlightClass = action === 'remove' ? 'highlight-remove' : 'highlight-add';
        inputField.classList.add(highlightClass);
        inputField.addEventListener('animationend', function() {
            inputField.classList.remove(highlightClass);
        }, { once: true });
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Shift') {
            if (!shiftScrollDone) {
                if (shiftOriginalScroll === null) {
                    shiftOriginalScroll = window.scrollY || 0;
                }
                const anchor = document.getElementById('sixFtAnchor');
                if (anchor) {
                    anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                shiftScrollDone = true;
            }
        }
        if (event.code === 'Home') {
            setRemoveMode(true);
            event.preventDefault();
            return;
        }
        const activeTag = document.activeElement.tagName;
        if (activeTag === 'INPUT' || activeTag === 'TEXTAREA' || activeTag === 'SELECT') {
            return;
        }
        const code = event.code;
        if (!keyMap[code]) {
            return;
        }
        event.preventDefault();
        const action = homeRemoveActive || event.shiftKey ? 'remove' : 'add';
        fetch("/body_pieces", {
            method: "POST",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ key_code: code, action: action })
        }).then(response => response.json())
        .then(data => {
            if (data.success && data.part_key) {
                applyCountUpdate(data.part_key, data.new_count, data.action);
                updateActionStatus(data.part_key, data.action);
            }
        }).catch(error => {
            console.error("Error updating count:", error);
        });
    });

    document.addEventListener('keyup', function(event) {
        if (event.code === 'Home') {
            setRemoveMode(false);
        }
        if (event.key === 'Shift') {
            shiftScrollDone = false;
            if (shiftOriginalScroll !== null) {
                window.scrollTo({ top: shiftOriginalScroll, behavior: 'smooth' });
                shiftOriginalScroll = null;
            }
        }
    });

    window.addEventListener('blur', function() {
        setRemoveMode(false);
    });
    </script>
</body>
</html>
